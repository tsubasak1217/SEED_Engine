#include "PhysicsComponent.h"
#include <SEED/Source/Basic/Object/GameObject.h>

/////////////////////////////////////////////////////////////////////////
// コンストラクタ
/////////////////////////////////////////////////////////////////////////
PhysicsComponent::PhysicsComponent(GameObject* pOwner, const std::string& tagName)
    : IComponent(pOwner, tagName){
    if(tagName == ""){
        componentTag_ = "Physics_ID:" + std::to_string(componentID_);
    }
}

/////////////////////////////////////////////////////////////////////////
// 初期化処理
/////////////////////////////////////////////////////////////////////////
void PhysicsComponent::Initialize(){
    // 重力方向の初期化(下方向)
    gravityDirection_ = Vector3(0.0f, -1.0f, 0.0f);
    // ベロシティの初期化
    velocity_ = Vector3();
    // 落下フラグの初期化
    isDrop_ = false;
    // 落下速度の初期化
    dropSpeed_ = 0.0f;
}

/////////////////////////////////////////////////////////////////////////
// フレーム開始時の処理
/////////////////////////////////////////////////////////////////////////
void PhysicsComponent::BeginFrame(){
    // 落下フラグの初期化
    isDrop_ = true;
}

/////////////////////////////////////////////////////////////////////////
// 更新処理
/////////////////////////////////////////////////////////////////////////
void PhysicsComponent::Update(){
    // ワールド基準でベロシティを加算する
    owner_->AddWorldTranslate(velocity_ * ClockManager::DeltaTime());
}


/////////////////////////////////////////////////////////////////////////
// 描画処理
/////////////////////////////////////////////////////////////////////////
void PhysicsComponent::Draw(){
}


/////////////////////////////////////////////////////////////////////////
// コンストラクタ
/////////////////////////////////////////////////////////////////////////
void PhysicsComponent::EndFrame(){

    // 落下フラグの更新(一時的にy0で止めるようにしておく)
    if(owner_->GetWorldTranslate().y <= 0.0f){
        isDrop_ = false;
    }

    // 終了時の落下フラグに応じた処理
    if(isDrop_){
        float downAccel = Physics::kGravity * ClockManager::DeltaTime();
        dropSpeed_ += downAccel;
        velocity_ = gravityDirection_ * dropSpeed_;
    } else{
        dropSpeed_ = 0.0f;
        velocity_ = Vector3(0.0f);
    }
}


/////////////////////////////////////////////////////////////////////////
// フレーム終了時の処理
/////////////////////////////////////////////////////////////////////////
void PhysicsComponent::Finalize(){
}


/////////////////////////////////////////////////////////////////////////
// GUI上での編集処理
/////////////////////////////////////////////////////////////////////////
void PhysicsComponent::EditGUI(){
}


/////////////////////////////////////////////////////////////////////////
// jsonへの書き出し
/////////////////////////////////////////////////////////////////////////
nlohmann::json PhysicsComponent::GetJsonData() const{
    return nlohmann::json();
}


/////////////////////////////////////////////////////////////////////////
// jsonからの読み込み処理
/////////////////////////////////////////////////////////////////////////
void PhysicsComponent::LoadFromJson(const nlohmann::json& jsonData){
    jsonData;
}
