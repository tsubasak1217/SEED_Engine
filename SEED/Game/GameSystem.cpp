#include "GameSystem.h"
#include <SEED/Source/Manager/SceneManager/SceneManager.h>
#include <SEED/Source/Basic/Scene/SceneRegister.h>
#include <SEED/Source/Manager/ImGuiManager/ImGuiManager.h>
#include <SEED/Source/Manager/VideoManager/VideoManager.h>

/////////////////////////////////////////////////////////////////
// 静的メンバ変数の初期化
/////////////////////////////////////////////////////////////////
std::unique_ptr<GameSystem> GameSystem::instance_ = nullptr;


/////////////////////////////////////////////////////////////////
// インスタンス取得
/////////////////////////////////////////////////////////////////
GameSystem* GameSystem::GetInstance() {
    if (instance_ == nullptr) {
        instance_.reset(new GameSystem());
    }
    return instance_.get();
}

/////////////////////////////////////////////////////////////////
// ゲームの初期化
/////////////////////////////////////////////////////////////////
void GameSystem::Initialize() {
    GetInstance();
    // シーンの登録
    SceneRegister::RegisterScenes();
    // 最初のシーンを設定
    ChangeScene("Select");
}

/////////////////////////////////////////////////////////////////
// ゲームの終了処理
/////////////////////////////////////////////////////////////////
void GameSystem::Finalize() {
    instance_->pScene_->Finalize();
}


/////////////////////////////////////////////////////////////////
// ゲームの実行
/////////////////////////////////////////////////////////////////
void GameSystem::Run() {
    // フレーム開始処理
    instance_->BeginFrame();
    // ゲームの更新処理
    instance_->Update();
    // ゲームの描画処理
    instance_->Draw();
    // フレーム終了処理
    instance_->EndFrame();
}


/////////////////////////////////////////////////////////////////
// ゲームの更新処理
/////////////////////////////////////////////////////////////////
void GameSystem::Update() {
    // シーンの更新
    instance_->pScene_->Update();
    // ビデオの更新
    VideoManager::GetInstance()->Update();
    // エフェクトの更新
    EffectSystem::Update();
    // すべての更新終了後にカメラを更新
    CameraManager::Update();
}


/////////////////////////////////////////////////////////////////
// ゲームの描画処理
/////////////////////////////////////////////////////////////////
void GameSystem::Draw() {
    
    // シーンの描画
    if (instance_->pScene_) {
        instance_->pScene_->Draw();
    }

    // エフェクトの描画
    EffectSystem::Draw();
    
    // ImGuiの描画
    DrawGUI();
}


/////////////////////////////////////////////////////////////////
// フレーム開始処理
/////////////////////////////////////////////////////////////////
void GameSystem::BeginFrame() {
    // Colliderのリセット
    CollisionManager::ResetColliderList();
    // シーンのフレーム開始処理
    instance_->pScene_->BeginFrame();
    // Colliderの追加
    instance_->pScene_->HandOverColliders();
    // 当たり判定
    CollisionManager::CheckCollision();
    // コリジョンの描画だけ先に行う
    CollisionManager::Draw();
}


/////////////////////////////////////////////////////////////////
// フレーム終了処理
/////////////////////////////////////////////////////////////////
void GameSystem::EndFrame() {
    // シーンのフレーム終了処理
    if (instance_->pScene_) {
        instance_->pScene_->EndFrame();
    }
}

/////////////////////////////////////////////////////////////////
// ゲームのGUI描画処理
/////////////////////////////////////////////////////////////////
void GameSystem::DrawGUI(){
#ifdef _DEBUG
    CollisionManager::GUI();
#endif // _DEBUG
}


/////////////////////////////////////////////////////////////////
// シーンの変更
/////////////////////////////////////////////////////////////////
void GameSystem::ChangeScene(const std::string& sceneName) {
    instance_->pScene_.reset(SceneManager::CreateScene(sceneName));
    instance_->pScene_->Initialize();
}
