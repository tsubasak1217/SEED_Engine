#include <Game/Scene/Scene_Clear/Scene_Clear.h>

///etc
#include <SEED/Lib/Functions/MyFunc/MyFunc.h>
#include <Game/Objects/Result/ResultDrawer.h>

////////////////////////////////////////////////////////////////////////////////////////////
//
// コンストラクタ・デストラクタ
//
////////////////////////////////////////////////////////////////////////////////////////////
Scene_Clear::Scene_Clear(){
    Initialize();
}

Scene_Clear::~Scene_Clear(){}


////////////////////////////////////////////////////////////////////////////////////////////
//
// 初期化
//
////////////////////////////////////////////////////////////////////////////////////////////
void Scene_Clear::Initialize(){
    SEED::SetMainCamera("default");
    ResultDrawer::Initialize();
}

////////////////////////////////////////////////////////////////////////////////////////////
//
// 終了処理
//
////////////////////////////////////////////////////////////////////////////////////////////
void Scene_Clear::Finalize(){}

////////////////////////////////////////////////////////////////////////////////////////////
//
// 更新
//
////////////////////////////////////////////////////////////////////////////////////////////
void Scene_Clear::Update(){

    if(currentState_){
        currentState_->Update();
    }

    if(currentEventState_){
        currentEventState_->Update();
    }

    // タイマーの更新
    if(Input::IsTriggerKey(DIK_SPACE)){
        step_++;
        stepTimer_.Reset();
    
    } else if(stepTimer_.IsFinishedNow()){
        step_++;
        stepTimer_.Reset();
    
    }

    // 時間の更新
    stepTimer_.Update();

#ifdef _DEBUG
    ResultDrawer::Edit();
#endif // _DEBUG
}

////////////////////////////////////////////////////////////////////////////////////////////
//
// 描画
//
////////////////////////////////////////////////////////////////////////////////////////////
void Scene_Clear::Draw(){
    if(currentState_){
        currentState_->Draw();
    }

    if(currentEventState_){
        currentEventState_->Draw();
    }

    //
    ResultDrawer::DrawResult(ResultStep(step_), stepTimer_.GetProgress());
}

////////////////////////////////////////////////////////////////////////////////////////////
//
// フレーム開始処理
//
////////////////////////////////////////////////////////////////////////////////////////////
void Scene_Clear::BeginFrame(){
    Scene_Base::BeginFrame();

    if(currentState_){
        currentState_->BeginFrame();
    }
}

////////////////////////////////////////////////////////////////////////////////////////////
//
// フレーム終了処理
//
////////////////////////////////////////////////////////////////////////////////////////////
void Scene_Clear::EndFrame(){

    // ステップのチェック
    CheckStep();

    if(currentState_){
        currentState_->EndFrame();
    }

    if(sceneChangeOrder){
        ChangeScene("Game");
        return;
    }
}


/////////////////////////////////////////////////////////////////////////////////////////
//
//  すべてのコライダーをコリジョンマネージャに渡す
//
/////////////////////////////////////////////////////////////////////////////////////////
void Scene_Clear::HandOverColliders(){
    if(currentState_){
        currentState_->HandOverColliders();
    }
}

/////////////////////////////////////////////////////////////////////////////////////////
// ステップのチェック
/////////////////////////////////////////////////////////////////////////////////////////
void Scene_Clear::CheckStep(){
    if(step_ >= kMaxStep_){
        if(Input::IsTriggerKey(DIK_SPACE)){
            sceneChangeOrder = true;
        }
    }
}
