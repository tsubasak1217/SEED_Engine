#include "GameSystem.h"
#include <SceneManager/SceneManager.h>
#include "SceneRegister.h"

/////////////////////////////////////////////////////////////////
// 静的メンバ変数の初期化
/////////////////////////////////////////////////////////////////
std::unique_ptr<GameSystem> GameSystem::instance_ = nullptr;


/////////////////////////////////////////////////////////////////
// インスタンス取得
/////////////////////////////////////////////////////////////////
GameSystem* GameSystem::GetInstance() {
    if (instance_ == nullptr) {
        instance_.reset(new GameSystem());
    }
    return instance_.get();
}

/////////////////////////////////////////////////////////////////
// ゲームの初期化
/////////////////////////////////////////////////////////////////
void GameSystem::Initialize() {
    GetInstance();
    // シーンの登録
    SceneRegister::RegisterScenes();
    // 最初のシーンを設定
    ChangeScene("Clear");
}


/////////////////////////////////////////////////////////////////
// ゲームの終了処理
/////////////////////////////////////////////////////////////////
void GameSystem::Finalize() {
    instance_->pScene_->Finalize();
    instance_->pScene_.reset();
}


/////////////////////////////////////////////////////////////////
// ゲームの実行
/////////////////////////////////////////////////////////////////
void GameSystem::Run() {
    // フレーム開始処理
    instance_->BeginFrame();
    // ゲームの更新処理
    instance_->Update();
    // ゲームの描画処理
    instance_->Draw();
    // フレーム終了処理
    instance_->EndFrame();
}


/////////////////////////////////////////////////////////////////
// ゲームの更新処理
/////////////////////////////////////////////////////////////////
void GameSystem::Update() {
    // シーンの更新
    instance_->pScene_->Update();
    // Colliderの追加
    instance_->pScene_->HandOverColliders();
    // 当たり判定
    CollisionManager::CheckCollision();
    // すべての更新終了後にカメラを更新
    CameraManager::Update();
}


/////////////////////////////////////////////////////////////////
// ゲームの描画処理
/////////////////////////////////////////////////////////////////
void GameSystem::Draw() {
    
    // シーンの描画
    if (instance_->pScene_) {
        instance_->pScene_->Draw();
    }

    // コリジョンの描画(デバッグ表示)
    CollisionManager::Draw();
}


/////////////////////////////////////////////////////////////////
// フレーム開始処理
/////////////////////////////////////////////////////////////////
void GameSystem::BeginFrame() {
    // Colliderのリセット
    CollisionManager::ResetColliderList();
    // シーンのフレーム開始処理
    instance_->pScene_->BeginFrame();
}


/////////////////////////////////////////////////////////////////
// フレーム終了処理
/////////////////////////////////////////////////////////////////
void GameSystem::EndFrame() {
    // シーンのフレーム終了処理
    if (instance_->pScene_) {
        instance_->pScene_->EndFrame();
    }
}


/////////////////////////////////////////////////////////////////
// シーンの変更
/////////////////////////////////////////////////////////////////
void GameSystem::ChangeScene(const std::string& sceneName) {
    instance_->pScene_.reset(SceneManager::CreateScene(sceneName));
}
