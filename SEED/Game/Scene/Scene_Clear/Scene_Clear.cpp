#include <Game/Scene/Scene_Clear/Scene_Clear.h>

///etc
#include <Game/Components/ResultUpdateComponent.h>

////////////////////////////////////////////////////////////////////////////////////////////
//
// コンストラクタ・デストラクタ
//
////////////////////////////////////////////////////////////////////////////////////////////
Scene_Clear::Scene_Clear() : Scene_Base(){
}

Scene_Clear::~Scene_Clear(){
    SEED::AudioManager::EndAudio(bgmHandle_);
}


////////////////////////////////////////////////////////////////////////////////////////////
//
// 初期化
//
////////////////////////////////////////////////////////////////////////////////////////////
void Scene_Clear::Initialize(){
    SEED::Instance::SetMainCamera("default");

    // リザルト更新用オブジェクトの生成
    SEED::Hierarchy* hierarchy = GetHierarchy();
    resultUpdater_ = hierarchy->CreateEmptyObject2D();
    resultUpdater_->AddComponent<ResultUpdate2DComponent>();
}

////////////////////////////////////////////////////////////////////////////////////////////
//
// 更新
//
////////////////////////////////////////////////////////////////////////////////////////////
void Scene_Clear::Update(){

    // 共通更新
    Scene_Base::Update();

    if(bgmHandle_ == -1){
        bgmHandle_ = SEED::AudioManager::PlayAudio(AudioDictionary::Get("ResultBGM"), true, 0.5f);
    }

    // タイマーの更新
    if(SEED::Input::IsTriggerAnyKey()){
        step_++;
        stepTimer_.Reset();

    } else if(stepTimer_.IsFinishedNow()){
        step_++;
        stepTimer_.Reset();

    }

    // 時間の更新
    stepTimer_.Update();
}

////////////////////////////////////////////////////////////////////////////////////////////
//
// 描画
//
////////////////////////////////////////////////////////////////////////////////////////////
void Scene_Clear::Draw(){
    Scene_Base::Draw();

    //
}

////////////////////////////////////////////////////////////////////////////////////////////
//
// フレーム開始処理
//
////////////////////////////////////////////////////////////////////////////////////////////
void Scene_Clear::BeginFrame(){
    Scene_Base::BeginFrame();
}

////////////////////////////////////////////////////////////////////////////////////////////
//
// フレーム終了処理
//
////////////////////////////////////////////////////////////////////////////////////////////
void Scene_Clear::EndFrame(){

    Scene_Base::EndFrame();

    // ステップのチェック
    CheckStep();

    if(sceneChangeOrder){
        ChangeScene("Game");
        return;
    }
}

/////////////////////////////////////////////////////////////////////////////////////////
// ステップのチェック
/////////////////////////////////////////////////////////////////////////////////////////
void Scene_Clear::CheckStep(){
    if(step_ >= kMaxStep_){
        if(SEED::Input::IsTriggerAnyKey() or SEED::Input::IsTriggerMouse(SEED::MOUSE_BUTTON::LEFT)){
            sceneChangeOrder = true;
        }
    }
}
